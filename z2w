#! /usr/bin/perl
#   z2w - convert ZeroMQ document to Wikidot format
#   - converts [[code type="textdiagram"]] via ditaa
#   - converts zmq_something(3) into URL to http://api.zeromq.org
#   Eventually meant to produce print-ready output via tex
#
#   Usage: z2w < docfile
#
#   Creates Wikidot file in wdtemp.txt and images in images/.
#   By Pieter Hintjens, free for remixing without conditions.
#   Images are stored in the github repository at
#   http://github.com/imatix/0MQGuide.
#

$git = "http://github.com/imatix/zguide";
$branch = "master";

sub get_filename {
    local ($name, $type) = @_;          #   Get arguments
    if ($type eq "c") {
        return "examples/c/$name.c";
    }
    elsif ($type eq "c++") {
        return "examples/c++/$name.cpp";
    }
    elsif ($type eq "python") {
        return "examples/python/$name.py";
    }
    else {
        print "Unknown type $type for $name\n";
        exit (1);
    }
}

if (!open (WDTEMP, ">wdtemp.txt")) {
    print "Can't create wdtemp.txt: $!\n";
    exit (1);
}
if (!open (IMAGES, ">images.html")) {
    print "Can't create images.html: $!\n";
    exit (1);
}

print WDTEMP "[!-- Generated documentation file, do not edit --]\n";
print IMAGES "<html>\n";

while (<>) {
    chop;
    if (/\[\[code type=\"(.+)\" title=\"(.+)\" name=\"(.+)\"\]\]/) {
        $type = $1;
        $title = $2;
        $name = $3;
        print WDTEMP "$_\n";

        #   Discard any real contents of code block
        while (<>) {
            last if /\[\[\/code\]\]/;
            print "W: discarding $type code for $name\n";
        }
        $filename = get_filename ($name, $type);
        if (!open (SOURCE, $filename)) {
            print "Can't open $filename: $!\n";
            exit (1);
        }
        while (<SOURCE>) {
            print WDTEMP $_;
        }
        close (SOURCE);
        print WDTEMP "[[>]]\n";
        print WDTEMP "[*$git/blob/$branch/$filename Source] | [*$git/tree/$branch/examples Translate]\n";
        print WDTEMP "[[/>]]\n";
    }
    elsif ($_ eq "[[code type=\"textdiagram\"]]") {
        #   Text diagram
        $image = $image + 1;
        print IMAGES "<pre class=\"textdiagram\" id=\"fig$image\">\n";
        while (<>) {
            chop;
            last if /\[\[\/code\]\]/;
            s/#/$image/;
            print IMAGES "$_\n";
        }
        print IMAGES "</pre>\n";
        #   Link to resource in git, nice way to upload images
        print WDTEMP "[[=image $git/raw/$branch/images/fig$image.png]]\n";
    }
    else {
        #   Normal text
        s/0MQ/Ã˜MQ/g;
        s/0\\MQ/0MQ/g;
        $remainder = $_;
        while ($remainder =~ /zmq_([^(]+)\(3\)/) {
            print WDTEMP $`;
            print WDTEMP "[http://api.zeromq.org/zmq_$1.html zmq_$1(3)]";
            $remainder = $';
        }
        print WDTEMP $remainder."\n";
    }
}
print IMAGES "</html>\n";
close (IMAGES);
close (WDTEMP);

system ("rm -f images/*");
system ("java -jar ditaa0_9.jar images.html -o -h -E output.html");
#   Need to trim twice for reasons I don't care to explore
system ("mogrify -trim images/*.png");
system ("mogrify -trim images/*.png");
system ("rm output.html images.html");
